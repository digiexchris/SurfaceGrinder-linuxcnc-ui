O<ZMove_RepeatType0> sub
#4 = [#<_hal[grinder.z_min]>] 
#5 = [#<_hal[grinder.z_max]>] 
#6 = [#<_hal[grinder.z_crossfeed]>] 
#7 = [#<_hal[grinder.z_speed]>]
#8 = [#<_hal[grinder.z_direction]>]

( M65 P0 is setting z_direction to false, towards min )
( M64 P0 is setting z_direction to true, towards max )

IF [#<_hal[grinder.enable_z]> EQ 1]

   IF [Z LE #4]
      M64 P0
   ELSE IF [Z GE #5]
      M65 P0
   ENDIF

   #8 = [#<_hal[grinder.z_direction]>]

   IF [#8 EQ 0]
      #9 = [Z + #6]
      IF [#9 GT #5]
         G1 Z[#5] F[#7]
      ELSE
         G1 Z[#9] F[#7]
      ENDIF

      IF [Z GE #5]
         o<Disable_At_Z_Limit> call
      ENDIF
   ELSE
      #10 = [Z - #6]
      IF [#10 LT #4]
         G1 Z[#4] F[#7]
      ELSE
         G1 Z[#10] F[#7]
      ENDIF

      IF [Z LE #4]
         o<Disable_At_Z_Limit> call
      ENDIF
   ENDIF

ELSE
   IF [#<_hal[grinder.enable_x]> EQ 0]
   G04 P0.5 (Just so the interpreter isn't spinning, because both X and Z are off)
ENDIF

M99
O<ZMove_RepeatType0> endsub
